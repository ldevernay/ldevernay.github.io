---
layout: post
title:  "Réduire l'impact environnemental grâce à Gulp"
date:   2019-11-27 10:59:53 +0200
categories: green
---

Je vous avais déjà proposé une config gulp l'été dernier. Voici une version mise à jour. Plus complète, plus efficace et avec des bugs en moins. 

## Le pitch
Quand on regarde l'éco-conception d'un site web, on dégage souvent deux types de préconisations : 
* les optimisations techniques
* la sobriété numérique 
Pour ce qui est des optimisations techniques, certaines reviennent très souvent (notamment quand on teste avec [GreenIT-Analysis, le plugin Chrome qui va bien](https://www.greenit.fr/2019/07/02/web-evaluez-lempreinte-dune-page-en-un-clic/)). Notamment : 
* optimisation des images
* supprimer le CSS non-utilisé
* minifier les fichiers CSS et JS (voire les concaténer)
* optimiser la gestion du cache

L'été dernier, donc, je vous proposais une config gulp permettant d'automatiser une bonne partie de ces tâches (toutes sauf la gestion du cache). Depuis, j'ai essayé Webpack 4 mais ai trouvé cet outil moins intuitif que Gulp. J'ai donc décidé de reprendre Gulp mais en poussant plus loin la démarche. D'une part pour aller plus loin dans l'optimisation. D'autre part pour faciliter la prise en main de cette configuration.

## Gulp
Gulp permet d'automatiser des tâches, ce qui le rend très utile notamment pour le développement front.   
Pour cela, il s'appuie sur des modules npm dédiés qui permettent de faire tout sauf le café. 
* [Le site officiel](https://gulpjs.com/docs/en/getting-started/quick-start)
* [Un autre bon tuto mais en anglais](https://css-tricks.com/gulp-for-beginners/)

Pour pouvoir utiliser la configuration Gulp présentée ici, commencez par vous assurer que NPM a bien été initialisé pour votre projet. Pour cela, repérez un fichier package.json. Si vous ne le trouvez pas, lancez comme d'habitude la commande suivante : 

```
npm init
```

Après quelques péripéties (plugins dépréciés, syntaxe qui a changé d'une version à une autre, multiples possibilités pour chaque fonctionnalité, etc), je suis arrivé au fichier suivant (gulpfile.js) : 
```
var gulp = require('gulp');

var plugins = require('gulp-load-plugins')();

var source = './public';
var destination = './public/dist';

gulp.task('min-css', function () {
    return gulp.src(destination + '/css/app.css')
        .pipe(plugins.purifycss([source + 'app.js']))
        .pipe(plugins.csso())
        .pipe(plugins.rename({
            suffix: '.min'
        }))
        .pipe(gulp.dest(destination + '/css'));
});

gulp.task('min-js', function () {
    return gulp.src(source + '/js/app.js')
        .pipe(plugins.uglify())
        .pipe(plugins.rename({
            suffix: '.min'
        }))
        .pipe(gulp.dest(destination + '/js'));
});

gulp.task('min-img', function () {
    return gulp.src(source + '/images/*.+(png|jpg|gif|svg)')
        .pipe(plugins.cache(plugins.imagemin()))
        .pipe(gulp.dest(destination + '/images'));
});

gulp.task('default', gulp.series('min-css', 'min-js', 'min-img'), function () {
    return "Success!";
});

gulp.task('watch', function () {
    gulp.watch(source + '/css/app.css', ['css', 'min-css']);
});
```

Une fois celui-ci dispo dans le projet et les bons plugins NPM installé localement (gulp et tous les plugins assortis), il suffit de lancer "gulp" en ligne de commande dans le dit projet pour lancer toutes ces tâches.   
On retrouve alors dans le répertoire dist les fichiers minifiés ainsi que les images optimisées. 
Ce n'est évidemment qu'une première tentative et je suis preneur de retours pour savoir comment améliorer ce process. L'objectif est, à terme, d'automatiser tout un tas de tâches permettant d'améliorer l'efficience d'un site. 